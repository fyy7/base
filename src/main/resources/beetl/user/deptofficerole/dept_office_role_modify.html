<% include("../../common/head.html"){} %><SCRIPT type="text/javascript">var setting = {		check: {			enable: true,			chkboxType:  { "Y": "p", "N": "s" }		},		view: {			selectedMulti: false		},		data: {			key: {				title:"TITLE",				name:"TITLE"			},			simpleData: {				enable: true,				idKey: "RID",				pIdKey: "PARENTID"				}		},		callback: {			//onClick:onClickTree		}	};	var zNodes =null;			var rolesData=${ROLERIGHTS_JSON};
	function expandNode(e) {		var zTree = $.fn.zTree.getZTreeObj("treeData");		var type = e.data.type;		var nodes = zTree.getSelectedNodes();		if (type.indexOf("All")<0 && nodes.length == 0) {			alert("请先选择一个父节点");		}
		if (type == "expandAll") {			zTree.expandAll(true);		} else if (type == "collapseAll") {			zTree.expandAll(false);		}	}
	$(function(){		act_setSelectValue('<#encAction action="act"/>','rtype','select_dmb_query',{"DMLX":"RES_TYPE"},null,"RES_TYPE");		$("#expandAllBtn").bind("click", {type:"expandAll"}, expandNode);		$("#collapseAllBtn").bind("click", {type:"collapseAll"}, expandNode);			var node=null;		var roleRightsJson = ${ROLERIGHTS_BEAN};		$("#cleckType").click(function(){			var zTree = $.fn.zTree.getZTreeObj("treeData");			if($(this).is(":checked")){				setting.check.chkboxType={ "Y": "ps", "N": "s" };							}else{				setting.check.chkboxType={ "Y": "p", "N": "s" };			}			zTree.setting.check.chkboxType=setting.check.chkboxType		})				getDeptOfficeData();	});
	function saveData(){				var roleRightsAdd = "";		var roleRightsDel = "";		updateJsonData();		for(var key in rolesData){			if(rolesData[key]==true){				roleRightsAdd +=key + ";";				}else{				roleRightsDel+=key + ";";			}		}				roleRightsAdd = roleRightsAdd.substr(0,roleRightsAdd.length-1);		roleRightsDel = roleRightsDel.substr(0,roleRightsDel.length-1);		$("#RoleRights_Json").val(JSON.stringify(rolesData));		$("#RoleRights_Add").val(roleRightsAdd);		$("#RoleRights_Del").val(roleRightsDel);

		var b_find=false;		//部门		$("input[id^=id_dept_type_]").each(function(){			if($(this).prop('checked')){				b_find=true;				return false;			}		});
		if(b_find==false){			//职务			$("input[id^=id_office_type_]").each(function(){				if($(this).prop('checked')){					b_find=true;					return false;				}			});		}		if(b_find==false){			showMsg("请选择部门类型或职务类型！");			return;		}		submitFormData("form1","");	}
	//自动缩放	$(window).resize(function() {		$('#id_div_tree').height($(window).height() -30);	});	var oldappid=null;	function loadTreeData(){		//获取div内的值	var appid=$("#SEL_APP").val();	var channel_rtype=$("#SEL_APP").find("option[value='"+appid+"']").attr("rtype");		if(appid!==null&&channel_rtype!=null){			if(oldappid!=null){				updateJsonData();			}			oldappid=appid;					setCheckedValue("rtype",channel_rtype);					postAjax("restful?action=<#encAction action="get_resources_ourself"/>&APP_ID="+appid+"&CHANNEL_RTYPE="+channel_rtype,"","getTreeDataValue");		}	}	function getTreeDataValue(jsondata){			if(jsondata.g_result==1){					zNodes=	jsondata.value;			initTree();					}			}	function updateJsonData(){				var zTree = $.fn.zTree.getZTreeObj("treeData");		if(zTree){			//获取勾选的			var nodes = zTree.getCheckedNodes(true);					if(nodes.length>0){				for(var j=0;j<nodes.length;j++){					if(!rolesData[nodes[j].RID]){												//roleRightsAdd += nodes[j].RID + ";";							rolesData[nodes[j].RID]=true;					}				}			}			//获取未勾选的			nodes = zTree.getCheckedNodes(false);					if(nodes.length>0){				for(var j=0;j<nodes.length;j++){					if(rolesData[nodes[j].RID]){					//	roleRightsDel += nodes[j].RID + ";";						rolesData[nodes[j].RID]=false;					}				}			}		}		}	function initTree(){		$("#treeData").empty();			$.fn.zTree.init($("#treeData"), setting, zNodes);			var zTree = $.fn.zTree.getZTreeObj("treeData");			zTree.expandAll(true);				//for(i=0;i<rolesData.length;i++){				for(var key in rolesData){					node = zTree.getNodeByParam("RID",key,null);			if(node!=null){				zTree.checkNode(node,rolesData[key], false, true);				node.oldchecked="Y";			}			}	}	function getCheckedValue(name){		 var test = $("input[name='"+name+"']:checked");       var checkBoxValue = "";        test.each(function(){           checkBoxValue += $(this).val()+",";       })       checkBoxValue = checkBoxValue.substring(0,checkBoxValue.length-1);       return checkBoxValue;	}		function setCheckedValue(name,value){		 var test = $("input[name='"+name+"']:checkbox");  	        var checkBoxValue = ""; 	        test.each(function(){  			//	alert(value+":"+$(this).val()+":"+value.indexOf($(this).val()))	        	if(value.indexOf($(this).val())>-1){	        //		alert($(this).val());	        		$(this).prop('checked',true);	        	}else{	        	//	$(this).removeAttr("checked");	        		$(this).prop('checked',false);	        	}	           	        })  	}	//宣传列初始化	function tun2clecked(){		$("#rtype option[value='00002']").remove();		$("#rtype option[value='00001']").remove();		$("#rtype").prepend("<option value='default01'>菜单、按钮资源</option>");		act_select2Checkbox($("#rtype"));		if($("#menu_ul li a").eq(0)){			loadTreeData($("#menu_ul li a").eq(0));		}		}	function changeRtype(){		var value=getCheckedValue("rtype");			if(value){			if(oldappid&&value!=$("#SEL_APP").find("option[value='"+oldappid+"']").attr("rtype")){							$("#SEL_APP").find("option[value='"+oldappid+"']").attr("rtype",value);						loadTreeData();			}					}else{			showMsg("必须选择一个资源类型！");					setCheckedValue("rtype",$("#SEL_APP").find("option[value='"+oldappid+"']").attr("rtype"));		}	}			//根据机构id获取部门与职务类型	var optionAlreadyInstall = false;  function getDeptOfficeData(){    var organId = $("#id_select_organ").val();    postAjax("restful?action=<#encAction action="organdmb_option"/>&ORGAN_ID="+organId,"","getDeptOfficeDataResult");  }  function getDeptOfficeDataResult(jsondata){    if(jsondata.g_result==1){      /* 循环加载部门与职务类型checkbox */    	if(jsondata.ORGAN_DMB_LIST){        var dept_option_index = 0,office_option_index = 0,groupOptionNum=3,dept_option_td = $("#dept_option_td"),office_option_td = $("#office_option_td");        dept_option_td.empty();office_option_td.empty();        $.each(jsondata.ORGAN_DMB_LIST, function(n,value){          if (value.DMLX=='DEPT.TYPE'){            dept_option_index++;            dept_option_td.append("<input name='DEPT_TYPE' type='checkbox' value='"+value.DM+"' id='id_dept_type_"+dept_option_index+"' onclick='setValue(1,"+dept_option_index+");' /><label style='cursor: pointer;' for='id_dept_type_"+dept_option_index+"'>"+value.DMNR+"</label>");            if(dept_option_index%groupOptionNum==0){              dept_option_td.append("<br/>");            }          } else if (value.DMLX=='OFFICE.TYPE'){            office_option_index++;            office_option_td.append("<input name='OFFICE_TYPE' type='checkbox' value='"+value.DM+"' id='id_dept_type_"+office_option_index+"' onclick='setValue(1,"+office_option_index+");' /><label style='cursor: pointer;' for='id_dept_type_"+office_option_index+"'>"+value.DMNR+"</label>");            if(office_option_index%groupOptionNum==0){              office_option_td.append("<br/>");            }          }        });        /* 部门与职务类型勾选初始化 */        if(!optionAlreadyInstall){        	installOptions();        	optionAlreadyInstall = true;        }      }    }  }    function installOptions(){		  $("input[name='DEPT_TYPE'][value='${BEAN.DEPT_TYPE!}']").prop('checked',true);		  $("input[name='OFFICE_TYPE'][value='${BEAN.OFFICE_TYPE!}']").prop('checked',true);  }    // 部门与职务类型勾选事件  function setValue(type,num){    if(type==1){      //部门      if($("#id_dept_type_"+num).prop('checked')){        $("input[id^=id_dept_type_]").each(function(){          if($(this).attr("id")!="id_dept_type_"+num){            $(this).prop('checked',false);          }        });      }    }else{      //职务      if($("#id_office_type_"+num).prop('checked')){        $("input[id^=id_office_type_]").each(function(){          if($(this).attr("id")!="id_office_type_"+num){            $(this).prop('checked',false);          }        });      }    }  }</SCRIPT><div style="width: 260px; z-index: 9999; position: fixed ! important; right: 0px; top: 80px;">	<select name="rtype" id="rtype" onchange="changeRtype()" sucFunc="tun2clecked"></select></div><form id="form1" name="form1" method="post" action="restful">	<input type="hidden" name="action" value="<#encAction action="dept_office_role_save"/>" /> <INPUT type="hidden" name="ROLEID" value="${BEAN.ROLEID!}" /> <INPUT type="hidden" name="RoleRights_Add" id="RoleRights_Add" /> <INPUT type="hidden" name="RoleRights_Del" id="RoleRights_Del" /> <INPUT type="hidden" name="RoleRights_Json" id="RoleRights_Json" />	<div style="float: left; line-height: 30px; width: 40%;">		<div style='border: 1px solid #ccc; height: 120px;'>			<table width="100%" class="form_bod">				<tr>					<td>机构名称：<span><select id='id_select_organ' name='ORGAN_ID' style="width: 200px;" onchange="getDeptOfficeData()" required="true" warning="机构不能为空!" ${CMD=='U'?'disabled':''}>								<option value=''>--</option> <% for(SUPER in SUPER_LIST){ %>								<option value="${SUPER.ORGANID}" ${ORGAN_ID==SUPER.ORGANID?'selected':''}>${SUPER.NAME}--${SUPER.ORGANDM}</option> <% } %>						</select> </span>					</td>				</tr>				<tr>					<td>角色名称：<span><input type='text' name='ROLENAME' value="${BEAN.ROLENAME!}" style="width: 200px;" class="txtitem" required="true" check="yz_notblank" warning="角色名称不能为空！" /></span>					</td>				</tr>				<tr>					<td>角色备注：<span><input type='text' name='REMARK' value="${BEAN.REMARK!}" style="width: 200px;" class="txtitem" /></span><a href="#" class="easyui-linkbutton btn_query" onclick="saveData();return false;">保存</a>					</td>				</tr>			</table>		</div>		<div class="dept-office-role-options">			<table style="width: 100%" class="dept-office-role-table">				<tr>					<td style="border-bottom: 1px solid #ccc;">【部门类型】</td>				</tr>				<tr>					<td id="dept_option_td"></td>				</tr>				<tr>					<td style="border-bottom: 1px solid #ccc;">【职务类型】</td>				</tr>				<tr>					<td id="office_option_td"></td>				</tr>			</table>		</div>	</div>	<div style="float: right; width: 59%; border-left: 1px solid; padding-left: 5px">		系统切换： <select id="SEL_APP" onchange="loadTreeData(this)"> <% for(APPINFO in USERRIGHTS_TYPE){ %>			<option value="${APPINFO.APPID!}" rtype="${APPINFO.CHANNEL_RTYPE!}">${APPINFO.APPNAME!}</option> <%} %>		</select> <br /> <a id="expandAllBtn" href="#" class="easyui-linkbutton btn_edit" style="margin: 5px; height: 30px;" onclick="return false;">展开</a> <a id="collapseAllBtn" href="#" class="easyui-linkbutton btn_edit" style="margin: 0px; height: 30px;" onclick="return false;">折叠</a> <span><input id="cleckType" type="checkbox"><label for="cleckType">级联选择</label></span>		<div id="id_div_tree" style="overflow-y: auto; border-top: solid 1px;">			<ul id="treeData" class="ztree"></ul>		</div>	</div></form><% include("../../common/end.html"){} %>